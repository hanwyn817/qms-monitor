# VBA 本地统计方案（无 PDF / 无 LLM）

本目录提供一个可直接导入的 VBA 模块：

- `/Users/hanwyn/Project/qms-monitor/vba/qms_local_stats.bas`

## 目标

- 只做本地超期事件统计和提取
- 不调用 LLM
- 不导出 PDF
- 直接由 Excel VBA 打开并读取台账文件

## 使用步骤

1. 新建或打开一个启用宏的工作簿（`.xlsm`）。
2. 打开 VBA 编辑器（`Alt + F11`），`File -> Import File...` 导入 `qms_local_stats.bas`。
3. 在该工作簿内准备 `Config` 工作表，列结构与项目一致（A~Q）：
   - A: 序号
   - B: 主题
   - C: 质量模块
   - D: 年份
   - E: Excel 文件路径
   - F: sheet 表名称（数字或名称）
   - G: 编号列
   - H: 内容列
   - I: 发起日期列
   - J: 计划规则（列标字母或天数）
   - K: 状态列
   - L: 责任部门列
   - M: 责任人列
   - N: 分管 QA 列
   - O: 分管 QA 中层列
   - P: 未完成状态值（必填）
   - Q: 数据起始行（可选，默认 2）
4. 先在 Excel 宏列表中运行 `RunQmsPrecheckReport`（仅预检查，不做统计）。
5. 预检查通过后再运行 `RunQmsLocalStats`。
6. 程序会自动创建并写入这些工作表：
   - `Overdue_Events`：超期明细
   - `Summary`：汇总统计
   - `Precheck_Report`：预检查报告（可读/不可读/空表/日期异常）
   - `Log`：告警与异常

## 运行前强校验（RunQmsLocalStats）

统计运行前会严格校验（不通过则终止）：

- Config 第1行 A~Q 表头是否缺失
- 核心列 G/H/I 是否缺失或列标非法
- 可选列 K~O 若填写，列标是否非法
- J 列计划规则是否合法（字母列标或数字天数）
- Q 列数据起始行是否合法（数字且 >= 2）
- E 列路径及 F 列 sheet 是否可读
- P 列“未完成状态值”是否缺失
- 同模块 P 列是否冲突

校验失败时，会在 `Log` 写入 `ERROR/WARN` 明细，不进入统计。

## 台账预检查报告（RunQmsPrecheckReport）

该宏只扫描，不做统计，输出到 `Precheck_Report`：

- 配置校验：通过/失败
- 文件/Sheet可读：可读/不可读
- 表内容检查：正常/空表或仅表头/数据起始行越界/存在日期异常
- 日期异常数与示例（最多显示5条样例）
- 备注（读取失败原因或配置问题）

## 与 Python 逻辑对齐点

- `J` 列：
  - 字母列标：按该列日期作为计划完成日期
  - 数字：`发起日期 + 天数`
  - 空：`发起日期 + 1个月`
- `P` 列按模块强一致：
  - 同模块出现多个不同“未完成状态值”会报错终止
- `Q` 列最小为 2，空值默认 2
- 日期解析失败会记录到 `Log`
- 支持识别并跳过“表头样式”的伪数据行

## 注意事项

- 建议文件路径（E列）使用绝对路径；相对路径会按当前 `.xlsm` 所在目录解析。
- 已做性能优化（关闭屏幕刷新、事件、自动计算；批量读取 Range 到数组）。
- 运行结束后会恢复 Excel 全局设置。

## 兼容性说明

- 模块使用晚绑定（`CreateObject("Scripting.Dictionary")`），无需额外勾选 VBA 引用库。
- 日期与列规则解析已改为纯 VBA 字符判断，不依赖 `VBScript.RegExp`。
- 打开外部台账时会优先尝试“只读 + 禁用宏”模式；若当前 Excel 版本不支持部分参数，会自动回退到兼容打开方式。
- 路径解析兼容：
  - Windows 盘符路径（如 `D:\...`）
  - UNC 路径（如 `\\server\share\...`）
  - macOS/Unix 绝对路径（如 `/Users/...`）

## 异常提示

- 配置校验失败会直接阻断统计，并在弹窗中给出错误数量和示例，详细项写入 `Log`。
- 预检查结果会写入 `Precheck_Report`，并在 `Log` 中按 `INFO/ERROR/WARN` 分级记录。
- 常见错误（文件不存在、Sheet 名称不存在/索引越界）会输出更明确提示，便于排查。
